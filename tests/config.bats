TEST_SECTION="Configuration resolution"
DUMMY_RSA_CONFIGFILE="-----BEGIN RSA PRIVATE KEY-----\nMIIEogIBAAKCAQEAtfV97Tef7flu8khNdOvOyFzt847nTRH9zrbySOCw1BOjVsp/\nTtowRlS0A3dKl6pVeHeWH/ig4E8N//QfhBLX/zMmVeJMYvN9XVkr9A16ZQQgPTYK\nSA35xPpniVw03EoxhlyNVWNq7l/wx1kO9MJkVyF4lTywHlk/MSi4v02eBLCvuF0a\nJ5xqtAnoGyKBSayMxhVqDC3mwgpBMnegJ3EGa3AgvVr0fPV6OMahJehAqGbbAjyu\nFVG1aY2n2JAxzY621zlwYJy2ozS1w4JlGKm71/bwSOtI53zAR8CNo6hX7DSYr69l\n5XpzznyEPkfYKM/7JfWvoL1BPjxwktywHz1w+wIDAQABAoH/F3SNxwZkl0iQBKtN\nUMUU4r8X7U1+g3DORtdOZBaStMPTSlzQDFoT3v0MN2YpN2O9oMnJkFV8Z23JYDUX\n2u6S6VKunmONdTPt9RqJj+ws2titTzaoHKGwkLO2pP490ie+OpOzpE4seo3je87/\nHo3wYUrvQE2SZlcazjtxlTdsJy5nkxhhcjj90y8OuG2obg6Sl7vnMuRmqDO/fq1X\nnYkabglMUAqlkiUZPce/xhGub6TpvxgP9lhcsJ+Hs1aPGxTFTJPIATXSnRvz/5rn\nESj7TL1wsG/SreMelON+fLNK/f1xGz7lp0ATqGTl9EPOGJF1PN2H5bwi4f1kw46i\nLC5pAoGBAO1kxyWeusf4UdzfmaV5SK7RpoaCFVt00MDIwlSD3ZDQQ77E8GahU2kM\ntxINkJHUId/3XT4/E1lQOgspInmVE/nUwGzRJwC2eOntTx0EtDyhw//wLcjjEp87\nzBDMy9tnqvjWOH9W5Qlvb2+qstS7vAXj/zG3frdgFtJg2R9p/vldAoGBAMQ4b4O6\ngSY+PNWsIRM3c1zLREEm1dSd4QakeH+sSBEGsl9DW1qPrGOCVXOGW+j4iBcK0Wek\niWtXgHNi4BHeLh7ogCXVWATdvygXsCuXWffD/qcy6BKCyMgTplMi7bU0xFGGjiVm\npwY8Xhmh1PEcm0wYqrYN+HWPl9ZosugjSXY3AoGBAOk8O2Edy3tO4Pc2BJoMSDni\nJ08+HUemxLa0SCGLETQHOpgCnALpe67ZXEBzbVepaMLIISdYB2WXqf9vIbz8mAy8\nV3ZSI5TSsod6rWDgT0jG0m/yBLm7R3+E26Ch5aQh/VvP9OA/enXDs2Ot/Vd/P2M2\nN3McSnZWBPYbSxdPJ8DNAoGAJsy+CD810HkYEGxD8gfR8PRkn7ltKOi7GVQmW6CW\nc39uf/XSt5qXTOn1ua1EuVGDn4LNG4Bmh+o6hRZ1FjNnzUbOKC0ChZvPc78TX9tC\nuAJydV9Ukmx4BVAVYHUUqfMwKqq/qteciVggh1L/x1mPv8FU6EDk82IcdRIo5kwr\n94sCgYEAs2kdeoDBlEuz5v3sS0PHWGCdP3WRS88NE0KfAR4Fd5njOQcz/TU9tdtv\nxzJvshZF5nE9wuQbWn0WHbK8E5S35qGC6viWHbq1LrYyqKc0YCjKCYnH++E+8PH9\nr8mp+ENaUYJEN6tx4nWZznwWj0eUEbtd3N5YKXwqi+HqBbtqwtM=\n-----END RSA PRIVATE KEY-----"
DUMMY_RSA_ENVVAR="-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAojopzYyjN0SAtjTH5v6SH6qG9OeAS5MIHmZ3oXFeEMSFjKny\nM8wyHdmsS7DTGMspDE/vuTSv7ZrKmvBj7TBigEStQqUTdiXeiu1S5NBw3hv5HvDK\nxdnpXnWe985yglXAW1rIx/UVkkCtd53wPzd6Zh4fs7DDpj6lbuWFxHlHZZFCi4/M\nu8v88ccFV8jxycSuYW7bzc0Tbr1NxZH4vk92lQWbVGI5uDNvj4r+3A/030ydfpAR\nJ7tMHkytnaTdWqq4BUUZTEkZLjxOFG56kOzN012WHM1zkN+D0VCGAY08fXS/+d0y\nLHS9DCSbBXs6KnZxhk5tpOF2lUUW5uGKmPSOswIDAQABAoIBAG3hg4sMZUj8B0pi\n+bvGVmdIc9zSKR4HWwpsUT9ysEofMm4SdlELUC7Tz1X9UR6MDSOfyTnjK/5+SBkm\nFikECtPisJBhi4sNH21uTiVZ4fkvbU+9vTrB3MX0WVZz6S/KsV2vYiu+H3xOfrB0\ns9O92hPs94AYjIzABgHVSQPJOcjaxK5D6cd0InzYkSjHnPoQYBwqye49QeycRATL\nK+6X8OiEomZtZ2JYZkerfcmFrgeGMrU3c+U26ske7zxTZufgzFhRLZUsbSUirxsn\niinzWvYGel4UYTqa8mB++6VTJ4VkmCE7pG9TJzF8T0tiq6mrBsbs6R2OP+0pGBq8\nv/mLODECgYEA1IXWPuuRvNR7whlU6z5A+lUcYyf3R2a+2l1H4CjzpEgx8GvMyHRb\nj9ZZTpShqHfELFkd2JL7vlanMiS+2HdTrmGSarlKAZLXkoFRdQiZQftZOPTBkqkV\nF0MhAgw6FYyJOOZnFIMr0oUqhpFMUcouxW/E1YhPCuNwTyojxWZU2g8CgYEAw2pD\nr7o1mj98ki/zS2fU5BuTnZAHXqdiC10Ja4PinLivYzHZhJkAQFU3s3Tj0oE6ze4g\nqCKi7RYOmjEhJcDAN1HXz5U2AR4z+f+Qp7p3zedBwf8A78deBUgzQG+MIDaqjwMz\nF8vd1I0R29iZfRJ3fXqZDLgOQQt65iRntcZhdR0CgYBFoRPwyX2WQIfLsEECUgM4\nAWqrkgySeDdPlABYkRJCYOT7wFX31yeomLHp7QiKCbNcVFZS/tU8J2fgJenhQjdI\niu9NyCdXHKVEetoVXhvYYmF5J7fENWGTnYrTAO6G4OSUn+hl8BQLhVXJgRFgOr3Y\nMiZrT52WE65YQZY2trBWQQKBgAZ0mznR5/VphX760Im8K19BvfWljWjGFMoVT7ta\nhwDwZPLc8becqlJ1vjpScThCBqRI6pFDW6iDYwYa+2JY5MCvFncIEdmlmsf2dlvk\nIBMQQa7b8rb5GhUIlpDZXoKt66J/049Er9ZWtrFRjXiBRKtDgozWA7qIW44Aw+BQ\nZmXNAoGBALoevfg+37bazrymhk4URFmjMetJX6UdYDW8u0FN4RH6tUocdFfmaxUl\nhIo/2yL9pfKs2Gy70ufXyfZRmBfgYcccQCacbGs51Iq1DzzizRmmeM6vht2tWJAX\nbXME0cg9PPbDrhf3cyp0xCBu0xoa+z5p0Gut8QCS2PCHrQYJF9uw\n-----END RSA PRIVATE KEY-----"
DUMMY_RSA_FLAG="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA4r/PkgZCT5lMeu2hWzHn+JQPDFY24VRKRCaDUw6Y34AwylcZ\nAWoAlHacjHe5I6EQ8t8ncxNQ785mHPo5dDkzT3aQUpaqTChz8eEDiAEVoYVM21i/\n4+F8pnZwWi6hqo2b71Ucep3wtG4QwObkVryQtXtMevJBl7dkUa1pqGiYkPyXt8cT\nWmqIVChWgFx5RKzMVlezsP1ZlkgWn1J7jvjZCd94K+JiMFRHNRSPPu1qGgRxzDDI\nG8yNxFTTB3vlHihmZILDG0Lc5+w7aRAQbN167Rx3Sz62wasCzw7Wp5DKoGuvgNol\n4H65bYps3qQytpkfxunRTsKbs9qJS2bwbCRESQIDAQABAoIBAQCKJiUYKboS9ypy\npv8tKb3UZJi6gniTVqCc3v4aB4W6fka7sM8qXmQWECIXLwZcn9BMuQs3AGjKgm0S\ncJ26ovMREgKiXutI1Ui28MoO/eIo86c86NiYxZQFc5nGSCz1VavQ6IEeb8XsmDaa\n4NHzypU8DPAu5BR0lCaJ4ObD1V5Gzokns4xxUUSkE4xV0BI5DISvvW/uQ2fB+e8g\nHQswXJbEBJjByboU4SlCAu/SORGzqN92p2UR0Mid980grrduKiNE9Gif/RGOCBJ3\nSL0WPMYrSipIBNL4iyDGcGK+suTlTZh9VW1ygeUuFPA0fxSa2RGcmHV4KW/fh8Xk\nt9zNIuGRAoGBAPGSxgVJQwnfi2+jTUoCqNdkyPhgzPgS0mEEDbDt0Va0rPNaXWy3\n8INADH0mHCiUOyMRczU1B4gnkbgccjiafWFxkTCX7o3Y9beBPqF5pjcf2iIWuu3i\nOJE8LUAIxTkCCDY3rNU4XPf4I49krZ25/JvV/gMLJDDipydxTWbh6pdNAoGBAPBK\nZ1JramC0WodP+Wrwzd2eCSPOziBaKoQd5KG3RMNvvPYRC/BBAbPYILXwUUJ3gSjU\nEqKoxcNLbLe0j7CzpAjYtdi6V0e8azfqY0Ond2BElehtsNgKMOrUHAvQOQu1mDi1\n/C39qFA27BKSm1Jd15FS5JlSRpz5P5skEcUOifrtAoGAIy4EuHBa2u07GR7m+og4\nnmWG/uTZ9KaJDKfSdpmrirz1EttuD48Z74M8Tl1mbGJp2kmIRY9bcXCRwAYkfCnD\naJVpV3JIw099OSQRQuK8WfrBgYVd45a2NjBVRqYAUrUBDSQ+fy6eG15/jzpSLk4P\ng4I+Y6MTuirHvO67Huh3iWECgYBbdAX1AXrgSWQ3IcIM6I+BrHdQEJK1D3wlAneU\n8PqT44Aoqv4/N46dU0HH3SogQPmAf46EJ/X0yU0ccfVKTGS/FTPIw8saO2UXR/b1\ntdQiaJgheTYYU3Cgv4/ZEyvTAA9qbiEHpAYeWXjp7LB+3caAwerNS9oiPl7t/gFh\nXZI4VQKBgQC2iBZPt5ntKVsAD59r82Z1t9kU2WU/L/oXmDPHwSqM7Upf8Bwf3v3F\nSw93m20buHVw5eeLbuyiamKVlcBCqq6SuS814gLV574p4Xvr4DFdUpE5lasWNdBp\njoInHR8paZCgEU+6bzRWpSJIOGZkMK2xnUG006sGnqpRn0wJgoWCFA==\n-----END RSA PRIVATE KEY-----"

@test "${TEST_SECTION}: show-configuration works" {
    run ./build/isctl show-configuration
    assert_success
}

@test "${TEST_SECTION}: config file works" {
    run ./build/isctl --config "${TEMP_CONFIG_FILE}" show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"configfile_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_CONFIGFILE}\\n\""
    assert_line "intersight_fqdn: \"configfile.intersight.com\""
    assert_line "intersight_insecure: false"
}

@test "${TEST_SECTION}: config file works with new config names" {
    run ./build/isctl --config "${TEMP_CONFIG_FILE_NEW}" show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"configfile_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_CONFIGFILE}\\n\""
    assert_line "intersight_fqdn: \"configfile.intersight.com\""
    assert_line "intersight_insecure: false"
}

@test "${TEST_SECTION}: uppercase environment variable overrides" {
    export INTERSIGHT_API_KEY_ID="envvar_key_id"
    export INTERSIGHT_SECRET_KEY="${TEMP_ENV_KEY_FILE}"
    export INTERSIGHT_FQDN="envvar.intersight.com"
    run ./build/isctl --config "${TEMP_CONFIG_FILE}" show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"envvar_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_ENVVAR}\\n\""
    assert_line "intersight_fqdn: \"envvar.intersight.com\""
    assert_line "intersight_insecure: false"
}

@test "${TEST_SECTION}: lowercase environment variable overrides" {
    export intersight_api_key_id="envvar_key_id"
    export intersight_secret_key="${TEMP_ENV_KEY_FILE}"
    export intersight_fqdn="envvar.intersight.com"
    run ./build/isctl --config "${TEMP_CONFIG_FILE}" show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"envvar_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_ENVVAR}\\n\""
    assert_line "intersight_fqdn: \"envvar.intersight.com\""
    assert_line "intersight_insecure: false"
}

@test "${TEST_SECTION}: old command line flags override" {
    export INTERSIGHT_API_KEY_ID="envvar_key_id"
    export INTERSIGHT_SECRET_KEY="${TEMP_ENV_KEY_FILE}"
    export INTERSIGHT_FQDN="envvar.intersight.com"
    export intersight_api_key_id="envvar_key_id"
    export intersight_secret_key="${TEMP_ENV_KEY_FILE}"
    export intersight_fqdn="envvar.intersight.com"
    run ./build/isctl --config "${TEMP_CONFIG_FILE}" --keyID flag_key_id --keyFile "${TEMP_FLAG_KEY_FILE}" --server "flag.intersight.com" --insecure show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"flag_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_FLAG}\\n\""
    assert_line "intersight_fqdn: \"flag.intersight.com\""
    assert_line "intersight_insecure: true"
}

@test "${TEST_SECTION}: new command line flags override" {
    export INTERSIGHT_API_KEY_ID="envvar_key_id"
    export INTERSIGHT_SECRET_KEY="${TEMP_ENV_KEY_FILE}"
    export INTERSIGHT_FQDN="envvar.intersight.com"
    export intersight_api_key_id="envvar_key_id"
    export intersight_secret_key="${TEMP_ENV_KEY_FILE}"
    export intersight_fqdn="envvar.intersight.com"
    run ./build/isctl --config "${TEMP_CONFIG_FILE}" --intersight-api-key-id flag_key_id --intersight-secret-key "${TEMP_FLAG_KEY_FILE}" --intersight-fqdn "flag.intersight.com" --insecure show-configuration
    assert_success
    assert_line "intersight_api_key_id: \"flag_key_id\""
    assert_line "intersight_secret_key: \"${DUMMY_RSA_FLAG}\\n\""
    assert_line "intersight_fqdn: \"flag.intersight.com\""
    assert_line "intersight_insecure: true"
}

setup_file() {
    export TEMP_DIR=$(mktemp -d)

    export TEMP_FLAG_KEY_FILE="${TEMP_DIR}/flagkey.pem"
    echo -e "${DUMMY_RSA_FLAG}" > $TEMP_FLAG_KEY_FILE
    
    export TEMP_ENV_KEY_FILE="${TEMP_DIR}/envkey.pem"
    echo -e "${DUMMY_RSA_ENVVAR}" > $TEMP_ENV_KEY_FILE

    export TEMP_KEY_FILE="${TEMP_DIR}/key.pem"
    echo -e "${DUMMY_RSA_CONFIGFILE}" > $TEMP_KEY_FILE

    export TEMP_CONFIG_FILE="${TEMP_DIR}/.isctl.yaml"
    echo -e "keyfile: ${TEMP_KEY_FILE}\nkeyid: configfile_key_id\noutput: default\nserver: configfile.intersight.com" > $TEMP_CONFIG_FILE

    export TEMP_CONFIG_FILE_NEW="${TEMP_DIR}/new.isctl.yaml"
    echo -e "intersight_secret_key: ${TEMP_KEY_FILE}\nintersight_api_key_id: configfile_key_id\noutput: default\nintersight_fqdn: configfile.intersight.com" > $TEMP_CONFIG_FILE_NEW
}
teardown_file() {
    echo "removing temp files ${TEMP_KEY_FILE} ${TEMP_CONFIG_FILE}"
    rm "${TEMP_CONFIG_FILE}"
    rm "${TEMP_CONFIG_FILE_NEW}"
    rm "${TEMP_KEY_FILE}"
    rm "${TEMP_ENV_KEY_FILE}"
    rm "${TEMP_FLAG_KEY_FILE}"
    rmdir "${TEMP_DIR}"
}

setup() {
    load 'test_helper/bats-support/load' # this is required by bats-assert!
    load 'test_helper/bats-assert/load'
}